name: CMake on macOS (Intel)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: macos-15-intel

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install sdl2 sdl2_mixer sdl2_net

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_OSX_ARCHITECTURES="x86_64" \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
          -DCMAKE_PREFIX_PATH="$(brew --prefix)" \
          -DCMAKE_C_FLAGS="-I$(brew --prefix)/include" \
          -DCMAKE_CXX_FLAGS="-I$(brew --prefix)/include" \
          -DCMAKE_EXE_LINKER_FLAGS="-L$(brew --prefix)/lib"

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Package .app Bundle
      run: |
        mkdir -p dist/linuxdoom-plus.app/Contents/MacOS
        mkdir -p dist/linuxdoom-plus.app/Contents/Frameworks
        
        cp build/linuxdoom-plus dist/linuxdoom-plus.app/Contents/MacOS/
        
        cp $(brew --prefix sdl2)/lib/libSDL2-2.0.0.dylib dist/linuxdoom-plus.app/Contents/Frameworks/
        cp $(brew --prefix sdl2_net)/lib/libSDL2_net-2.0.0.dylib dist/linuxdoom-plus.app/Contents/Frameworks/
        
        TARGET_EXE="dist/linuxdoom-plus.app/Contents/MacOS/linuxdoom-plus"
        chmod +x "$TARGET_EXE"
        
        install_name_tool -add_rpath "@executable_path/../Frameworks" "$TARGET_EXE" || true
        
        install_name_tool -change "$(brew --prefix sdl2)/lib/libSDL2-2.0.0.dylib" "@rpath/libSDL2-2.0.0.dylib" "$TARGET_EXE"
        install_name_tool -change "$(brew --prefix sdl2_net)/lib/libSDL2_net-2.0.0.dylib" "@rpath/libSDL2_net-2.0.0.dylib" "$TARGET_EXE"
        
        cat <<EOF > dist/linuxdoom-plus.app/Contents/Info.plist
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>linuxdoom-plus</string>
            <key>CFBundleIdentifier</key>
            <string>com.linuxdoom.plus</string>
            <key>CFBundleName</key>
            <string>LinuxDoom Plus</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
        </dict>
        </plist>
        EOF

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: linuxdoom-plus-mac-x86_64
        path: dist/linuxdoom-plus.app

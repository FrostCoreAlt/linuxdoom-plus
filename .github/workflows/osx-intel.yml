name: CMake on macOS (Intel)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: macos-15-intel

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install sdl2 sdl2_mixer sdl2_net

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_OSX_ARCHITECTURES="x86_64" \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
          -DCMAKE_PREFIX_PATH="$(brew --prefix)" \
          -DCMAKE_C_FLAGS="-I$(brew --prefix)/include" \
          -DCMAKE_CXX_FLAGS="-I$(brew --prefix)/include" \
          -DCMAKE_EXE_LINKER_FLAGS="-L$(brew --prefix)/lib"

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Set environment variables
      run: |
        echo "branch=${GITHUB_REF##*/}" >> $GITHUB_ENV
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - name: Package .app Bundle
      run: |
        mkdir -p dist/linuxdoom-plus.app/Contents/MacOS
        mkdir -p dist/linuxdoom-plus.app/Contents/Frameworks
        cp build/linuxdoom-plus dist/linuxdoom-plus.app/Contents/MacOS/
        cp $(brew --prefix sdl2)/lib/libSDL2-2.0.0.dylib dist/linuxdoom-plus.app/Contents/Frameworks/
        cp $(brew --prefix sdl2_mixer)/lib/libSDL2_mixer-2.0.0.dylib dist/linuxdoom-plus.app/Contents/Frameworks/
        cp $(brew --prefix sdl2_net)/lib/libSDL2_net-2.0.0.dylib dist/linuxdoom-plus.app/Contents/Frameworks/
        TARGET_EXE="dist/linuxdoom-plus.app/Contents/MacOS/linuxdoom-plus"
        chmod +x "$TARGET_EXE"
        for i in {1..3}; do
          for file in dist/$APP_NAME/Contents/Frameworks/*.dylib "$TARGET_EXE"; do
            otool -L "$file" | grep "/usr/local" | awk '{print $1}' | while read lib; do
              libname=$(basename "$lib")
              if [ ! -f "dist/$APP_NAME/Contents/Frameworks/$libname" ]; then
                cp "$lib" "dist/$APP_NAME/Contents/Frameworks/"
                chmod 755 "dist/$APP_NAME/Contents/Frameworks/$libname"
              fi
              install_name_tool -change "$lib" "@rpath/$libname" "$file"
            done
          done
        done
        cat <<EOF > dist/linuxdoom-plus.app/Contents/Info.plist
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>linuxdoom-plus</string>
            <key>CFBundleIdentifier</key>
            <string>com.linuxdoom.linuxdoom-plus</string>
            <key>CFBundleName</key>
            <string>LinuxDoom+</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
        </dict>
        </plist>
        EOF

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: linuxdoom-plus-dev-x86_64-mac-${{ env.branch }}-${{ env.sha_short }}
        path: dist/linuxdoom-plus.app
